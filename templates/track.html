<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Track your TTCP Worldwide shipment in real-time with GPS tracking and detailed status updates.">
    <title>Track Shipment | TTCP Worldwide</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="/static/images/logo.png">
    <link rel="apple-touch-icon" href="/static/images/logo.png">
    
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/static/css/style.css">
    
    <style>
        /* Track Page Specific Styles */
        .track-page {
            min-height: 100vh;
            background: var(--gray-50);
        }
        
        .track-hero {
            background: var(--gradient-dark);
            padding: 8rem 0 4rem;
            color: var(--white);
        }
        
        .track-hero-content {
            text-align: center;
            max-width: 700px;
            margin: 0 auto;
        }
        
        .track-hero h1 {
            color: var(--white);
            margin-bottom: 1rem;
        }
        
        .track-hero p {
            color: var(--gray-400);
            font-size: 1.1rem;
            margin-bottom: 2rem;
        }
        
        .track-search-box {
            display: flex;
            gap: 0.75rem;
            max-width: 600px;
            margin: 0 auto;
        }
        
        .track-search-box input {
            flex: 1;
            padding: 1rem 1.5rem;
            font-size: 1.1rem;
            border: 2px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            color: var(--white);
            transition: var(--transition-normal);
        }
        
        .track-search-box input::placeholder {
            color: var(--gray-400);
        }
        
        .track-search-box input:focus {
            outline: none;
            border-color: var(--secondary);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .track-content {
            padding: 3rem 0;
        }
        
        /* Loading State */
        .loading-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--gray-500);
        }
        
        .loading-state i {
            font-size: 3rem;
            color: var(--secondary);
            margin-bottom: 1rem;
        }
        
        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
        }
        
        .empty-state i {
            font-size: 4rem;
            color: var(--gray-300);
            margin-bottom: 1.5rem;
        }
        
        .empty-state h3 {
            margin-bottom: 0.5rem;
        }
        
        /* Shipment Details Grid */
        .shipment-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }
        
        @media (max-width: 1024px) {
            .shipment-grid {
                grid-template-columns: 1fr;
            }
        }
        
        /* Map Container */
        .track-map-container {
            background: var(--white);
            border-radius: var(--radius-xl);
            overflow: hidden;
            box-shadow: var(--shadow-lg);
            height: 500px;
        }
        
        #shipmentMap {
            width: 100%;
            height: 100%;
        }
        
        /* Info Cards */
        .info-card {
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
            padding: 1.5rem;
        }
        
        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--gray-200);
        }
        
        .card-header h3 {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            font-size: 1.1rem;
        }
        
        .card-header h3 i {
            color: var(--secondary);
        }
        
        /* Status Badge */
        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-full);
            font-size: 0.85rem;
            font-weight: 600;
        }
        
        .status-created {
            background: rgba(100, 116, 139, 0.1);
            color: var(--gray-600);
        }
        
        .status-in_transit, .status-in-transit {
            background: rgba(59, 130, 246, 0.1);
            color: var(--secondary);
        }
        
        .status-out_for_delivery, .status-out-for-delivery {
            background: rgba(245, 158, 11, 0.1);
            color: var(--warning);
        }
        
        .status-delivered {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success);
        }
        
        .status-failed, .status-exception {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }
        
        /* Info Grid */
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.25rem;
        }
        
        .info-item {
            padding: 0.75rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
        }
        
        .info-label {
            font-size: 0.8rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.25rem;
        }
        
        .info-value {
            font-weight: 600;
            color: var(--gray-800);
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--gray-200);
        }
        
        .timeline-item {
            position: relative;
            padding-bottom: 1.5rem;
        }
        
        .timeline-item:last-child {
            padding-bottom: 0;
        }
        
        .timeline-marker {
            position: absolute;
            left: -2rem;
            top: 0;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--gray-300);
            border: 3px solid var(--white);
            box-shadow: var(--shadow-sm);
        }
        
        .timeline-item.active .timeline-marker {
            background: var(--secondary);
        }
        
        .timeline-item.completed .timeline-marker {
            background: var(--success);
        }
        
        .timeline-content {
            background: var(--gray-50);
            padding: 1rem;
            border-radius: var(--radius-md);
        }
        
        .timeline-title {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.25rem;
        }
        
        .timeline-location {
            font-size: 0.9rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .timeline-location i {
            color: var(--secondary);
        }
        
        .timeline-time {
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        .timeline-notes {
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: var(--gray-600);
            font-style: italic;
        }
        
        /* Contact Cards */
        .contact-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        @media (max-width: 768px) {
            .contact-grid {
                grid-template-columns: 1fr;
            }
            
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .contact-card {
            padding: 1rem;
            background: var(--gray-50);
            border-radius: var(--radius-md);
        }
        
        .contact-card-title {
            font-size: 0.8rem;
            color: var(--gray-500);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .contact-name {
            font-weight: 600;
            color: var(--gray-800);
            margin-bottom: 0.5rem;
        }
        
        .contact-detail {
            font-size: 0.9rem;
            color: var(--gray-600);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }
        
        .contact-detail i {
            color: var(--secondary);
            width: 14px;
        }
        
        /* Progress Bar */
        .progress-container {
            margin-top: 1.5rem;
        }
        
        .progress-bar {
            height: 8px;
            background: var(--gray-200);
            border-radius: var(--radius-full);
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: var(--gradient-primary);
            border-radius: var(--radius-full);
            transition: width 0.5s ease;
        }
        
        .progress-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--gray-500);
        }
        
        /* Error state */
        .error-state {
            text-align: center;
            padding: 4rem 2rem;
            background: var(--white);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-md);
        }
        
        .error-state i {
            font-size: 4rem;
            color: var(--error);
            margin-bottom: 1.5rem;
        }
        
        /* Actions */
        .shipment-actions {
            display: flex;
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .shipment-actions .btn {
            flex: 1;
        }
    </style>
</head>
<body class="track-page">
    <!-- Header -->
    <header class="header" id="header">
        <nav class="nav-container">
            <a href="/" class="logo-section">
                <img src="/static/images/logo.png" alt="TTCP Worldwide" class="logo-img">
                <span class="logo-text">TTCP <span>Worldwide</span></span>
            </a>
            
            <div class="nav-menu" id="navMenu">
                <a href="/">Home</a>
                <a href="/#services">Services</a>
                <a href="/#features">Features</a>
                <a href="/#faq">FAQ</a>
            </div>
            
            <div class="nav-auth" id="navAuth">
                <a href="/signin" class="btn btn-secondary btn-sm">Sign In</a>
                <a href="/signup" class="btn btn-primary btn-sm">Get Started</a>
            </div>
            <div class="nav-auth nav-auth-logged-in" id="navAuthLoggedIn" style="display: none;">
                <a href="/profile" class="btn btn-secondary btn-sm">
                    <i class="fas fa-user"></i> My Profile
                </a>
                <a href="/auth/logout/" class="btn btn-primary btn-sm">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </a>
            </div>
            
            <!-- Mobile Menu Button -->
            <button class="mobile-menu-btn" id="mobileMenuBtn" aria-label="Toggle menu">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </nav>
    </header>

    <!-- Track Hero -->
    <section class="track-hero">
        <div class="container">
            <div class="track-hero-content">
                <h1>Track Your Shipment</h1>
                <p>Enter your tracking number to get real-time updates on your package location and delivery status.</p>
                
                <div class="track-search-box">
                    <input type="text" id="trackingNumber" placeholder="Enter tracking number (e.g., TTCP123456789)">
                    <button class="btn btn-accent btn-lg" id="trackBtn">
                        <i class="fas fa-search"></i>
                        Track
                    </button>
                </div>
            </div>
        </div>
    </section>

    <!-- Track Content -->
    <section class="track-content">
        <div class="container">
            <!-- Initial State -->
            <div id="initialState" class="empty-state">
                <i class="fas fa-box-open"></i>
                <h3>Enter Your Tracking Number</h3>
                <p>Enter your tracking number above to view shipment details, location, and delivery status.</p>
            </div>
            
            <!-- Loading State -->
            <div id="loadingState" class="loading-state" style="display: none;">
                <i class="fas fa-spinner fa-spin"></i>
                <p>Loading shipment details...</p>
            </div>
            
            <!-- Error State -->
            <div id="errorState" class="error-state" style="display: none;">
                <i class="fas fa-exclamation-circle"></i>
                <h3>Shipment Not Found</h3>
                <p id="errorMessage">We couldn't find a shipment with that tracking number. Please check and try again.</p>
            </div>
            
            <!-- Shipment Details -->
            <div id="shipmentDetails" style="display: none;">
                <div class="shipment-grid">
                    <!-- Left Column -->
                    <div>
                        <!-- Map -->
                        <div class="track-map-container">
                            <div id="shipmentMap"></div>
                        </div>
                        
                        <!-- Shipment Info -->
                        <div class="info-card" style="margin-top: 1.5rem;">
                            <div class="card-header">
                                <h3><i class="fas fa-box"></i> Shipment Details</h3>
                                <span class="status-badge" id="statusBadge">
                                    <i class="fas fa-circle"></i>
                                    <span id="statusText">In Transit</span>
                                </span>
                            </div>
                            
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Tracking Number</div>
                                    <div class="info-value" id="displayTrackingNumber">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Service Type</div>
                                    <div class="info-value" id="displayServiceType">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Weight</div>
                                    <div class="info-value" id="displayWeight">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Dimensions</div>
                                    <div class="info-value" id="displayDimensions">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Origin</div>
                                    <div class="info-value" id="displayOrigin">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Destination</div>
                                    <div class="info-value" id="displayDestination">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Created</div>
                                    <div class="info-value" id="displayCreated">--</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Est. Delivery</div>
                                    <div class="info-value" id="displayEstDelivery">--</div>
                                </div>
                            </div>
                            
                            <!-- Progress Bar -->
                            <div class="progress-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill" style="width: 0%;"></div>
                                </div>
                                <div class="progress-labels">
                                    <span>Created</span>
                                    <span>In Transit</span>
                                    <span>Out for Delivery</span>
                                    <span>Delivered</span>
                                </div>
                            </div>
                            
                            <!-- Actions -->
                            <div class="shipment-actions">
                                <button class="btn btn-outline" onclick="window.print()">
                                    <i class="fas fa-print"></i>
                                    Print
                                </button>
                                <button class="btn btn-primary" onclick="shareTracking()">
                                    <i class="fas fa-share-alt"></i>
                                    Share
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Right Column -->
                    <div>
                        <!-- Sender/Receiver Info -->
                        <div class="info-card">
                            <div class="card-header">
                                <h3><i class="fas fa-user"></i> Contact Information</h3>
                            </div>
                            
                            <div class="contact-grid">
                                <div class="contact-card">
                                    <div class="contact-card-title">
                                        <i class="fas fa-paper-plane"></i>
                                        Sender
                                    </div>
                                    <div class="contact-name" id="senderName">--</div>
                                    <!-- Sender email and phone hidden for privacy -->
                                </div>
                                
                                <div class="contact-card">
                                    <div class="contact-card-title">
                                        <i class="fas fa-inbox"></i>
                                        Receiver
                                    </div>
                                    <div class="contact-name" id="receiverName">--</div>
                                    <!-- Receiver email and phone hidden for privacy -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Timeline -->
                        <div class="info-card" style="margin-top: 1.5rem;">
                            <div class="card-header">
                                <h3><i class="fas fa-history"></i> Tracking History</h3>
                            </div>
                            
                            <div class="timeline" id="timeline">
                                <!-- Timeline items will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-grid">
                <div class="footer-brand">
                    <div class="logo-section">
                        <img src="/static/images/logo.png" alt="TTCP Worldwide" class="logo-img" style="height: 40px;">
                        <span class="logo-text">TTCP <span>Worldwide</span></span>
                    </div>
                    <p>Your trusted partner in global logistics. We deliver excellence, one package at a time.</p>
                    <div class="footer-social">
                        <a href="#"><i class="fab fa-facebook-f"></i></a>
                        <a href="#"><i class="fab fa-twitter"></i></a>
                        <a href="#"><i class="fab fa-linkedin-in"></i></a>
                        <a href="#"><i class="fab fa-instagram"></i></a>
                    </div>
                </div>
                
                <div class="footer-column">
                    <h4>Quick Links</h4>
                    <ul>
                        <li><a href="/">Home</a></li>
                        <li><a href="/track">Track Package</a></li>
                        <li><a href="/#services">Services</a></li>
                        <li><a href="/#features">Features</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h4>Services</h4>
                    <ul>
                        <li><a href="#">Air Freight</a></li>
                        <li><a href="#">Ocean Freight</a></li>
                        <li><a href="#">Ground Shipping</a></li>
                        <li><a href="#">Warehousing</a></li>
                    </ul>
                </div>
                
                <div class="footer-column">
                    <h4>Support</h4>
                    <ul>
                        <li><a href="/#faq">FAQ</a></li>
                        <li><a href="#">Contact Us</a></li>
                        <li><a href="#">Privacy Policy</a></li>
                        <li><a href="#">Terms of Service</a></li>
                    </ul>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p>&copy; 2025 TTCP Worldwide. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Header scroll effect
        const header = document.getElementById('header');
        window.addEventListener('scroll', () => {
            if (window.scrollY > 100) {
                header.classList.add('scrolled');
            } else {
                header.classList.remove('scrolled');
            }
        });

        // Initialize map
        let map = null;
        let markers = [];

        function initMap() {
            if (map) return;
            map = L.map('shipmentMap').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);
        }

        function clearMarkers() {
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];
        }

        // DOM Elements
        const trackingInput = document.getElementById('trackingNumber');
        const trackBtn = document.getElementById('trackBtn');
        const initialState = document.getElementById('initialState');
        const loadingState = document.getElementById('loadingState');
        const errorState = document.getElementById('errorState');
        const shipmentDetails = document.getElementById('shipmentDetails');

        // Show state functions
        function showState(state) {
            initialState.style.display = 'none';
            loadingState.style.display = 'none';
            errorState.style.display = 'none';
            shipmentDetails.style.display = 'none';
            state.style.display = 'block';
        }

        // Format date
        function formatDate(dateString) {
            if (!dateString) return '--';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        // Get status class
        function getStatusClass(status) {
            const statusMap = {
                'created': 'status-created',
                'in_transit': 'status-in_transit',
                'in-transit': 'status-in-transit',
                'out_for_delivery': 'status-out_for_delivery',
                'out-for-delivery': 'status-out-for-delivery',
                'delivered': 'status-delivered',
                'failed': 'status-failed',
                'exception': 'status-exception'
            };
            return statusMap[status.toLowerCase()] || 'status-created';
        }

        // Calculate progress
        function getProgress(status) {
            const progressMap = {
                'created': 15,
                'in_transit': 45,
                'in-transit': 45,
                'out_for_delivery': 75,
                'out-for-delivery': 75,
                'delivered': 100,
                'failed': 0
            };
            return progressMap[status.toLowerCase()] || 0;
        }

        // Render timeline
        function renderTimeline(events) {
            const timeline = document.getElementById('timeline');
            
            if (!events || events.length === 0) {
                timeline.innerHTML = '<p style="color: var(--gray-500); text-align: center;">No tracking events available.</p>';
                return;
            }

            // Sort events by timestamp (newest first)
            events.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            timeline.innerHTML = events.map((event, index) => `
                <div class="timeline-item ${index === 0 ? 'active' : 'completed'}">
                    <div class="timeline-marker"></div>
                    <div class="timeline-content">
                        <div class="timeline-title">${event.status_display || event.status}</div>
                        ${event.location ? `
                            <div class="timeline-location">
                                <i class="fas fa-map-marker-alt"></i>
                                ${event.location}
                            </div>
                        ` : ''}
                        <div class="timeline-time">${formatDate(event.timestamp)}</div>
                        ${event.notes ? `<div class="timeline-notes">${event.notes}</div>` : ''}
                    </div>
                </div>
            `).join('');
        }

        // Track shipment
        async function trackShipment(trackingNumber) {
            if (!trackingNumber.trim()) {
                alert('Please enter a tracking number');
                return;
            }

            showState(loadingState);
            trackBtn.disabled = true;

            try {
                const response = await fetch(`/api/shipment/${encodeURIComponent(trackingNumber)}/`);
                
                if (!response.ok) {
                    throw new Error('Shipment not found');
                }

                const data = await response.json();
                displayShipment(data);
                
            } catch (error) {
                document.getElementById('errorMessage').textContent = 
                    error.message === 'Shipment not found' 
                        ? "We couldn't find a shipment with that tracking number. Please check and try again."
                        : "An error occurred while fetching shipment data. Please try again.";
                showState(errorState);
            } finally {
                trackBtn.disabled = false;
            }
        }

        // Display shipment data
        function displayShipment(data) {
            // Update status badge
            const statusBadge = document.getElementById('statusBadge');
            const statusText = document.getElementById('statusText');
            statusBadge.className = `status-badge ${getStatusClass(data.status)}`;
            statusText.textContent = data.status_display || data.status;

            // Update info fields
            document.getElementById('displayTrackingNumber').textContent = data.tracking_number || '--';
            document.getElementById('displayServiceType').textContent = data.service_type || 'Standard';
            document.getElementById('displayWeight').textContent = data.weight ? `${data.weight} kg` : '--';
            document.getElementById('displayDimensions').textContent = data.dimensions || '--';
            document.getElementById('displayOrigin').textContent = data.origin || '--';
            document.getElementById('displayDestination').textContent = data.destination || '--';
            document.getElementById('displayCreated').textContent = formatDate(data.created_at);
            document.getElementById('displayEstDelivery').textContent = formatDate(data.estimated_delivery);

            // Update contact info
            document.getElementById('senderName').textContent = data.sender_name || '--';
            document.getElementById('senderEmail').textContent = data.sender_email || '--';
            document.getElementById('senderPhone').textContent = data.sender_phone || '--';
            document.getElementById('receiverName').textContent = data.receiver_name || '--';
            document.getElementById('receiverEmail').textContent = data.receiver_email || '--';
            document.getElementById('receiverPhone').textContent = data.receiver_phone || '--';

            // Update progress
            document.getElementById('progressFill').style.width = `${getProgress(data.status)}%`;

            // Render timeline
            renderTimeline(data.events || []);

            // Show shipment details
            showState(shipmentDetails);

            // Initialize and update map
            initMap();
            clearMarkers();
            
            // Add markers
            const bounds = [];
            
            // Origin marker
            if (data.origin_lat && data.origin_lng) {
                const originMarker = L.marker([data.origin_lat, data.origin_lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #10B981; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-paper-plane"></i></div>',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup(`<strong>Origin</strong><br>${data.origin || 'Starting point'}`);
                markers.push(originMarker);
                bounds.push([data.origin_lat, data.origin_lng]);
            }

            // Current location marker
            if (data.current_lat && data.current_lng) {
                const currentMarker = L.marker([data.current_lat, data.current_lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #3B82F6; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-truck"></i></div>',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup(`<strong>Current Location</strong><br>${data.current_location || 'In Transit'}`);
                markers.push(currentMarker);
                bounds.push([data.current_lat, data.current_lng]);
            }

            // Destination marker
            if (data.dest_lat && data.dest_lng) {
                const destMarker = L.marker([data.dest_lat, data.dest_lng], {
                    icon: L.divIcon({
                        className: 'custom-marker',
                        html: '<div style="background: #EF4444; color: white; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center;"><i class="fas fa-flag"></i></div>',
                        iconSize: [30, 30]
                    })
                }).addTo(map).bindPopup(`<strong>Destination</strong><br>${data.destination || 'End point'}`);
                markers.push(destMarker);
                bounds.push([data.dest_lat, data.dest_lng]);
            }

            // Fit map to bounds
            if (bounds.length > 0) {
                map.fitBounds(bounds, { padding: [50, 50] });
            }

            // Draw path
            if (bounds.length >= 2) {
                const polyline = L.polyline(bounds, {
                    color: '#3B82F6',
                    weight: 3,
                    opacity: 0.7,
                    dashArray: '10, 10'
                }).addTo(map);
                markers.push(polyline);
            }
        }

        // Share tracking
        function shareTracking() {
            const url = window.location.href;
            if (navigator.share) {
                navigator.share({
                    title: 'Track Shipment - TTCP Worldwide',
                    url: url
                });
            } else {
                navigator.clipboard.writeText(url).then(() => {
                    alert('Tracking link copied to clipboard!');
                });
            }
        }

        // Event listeners
        trackBtn.addEventListener('click', () => {
            trackShipment(trackingInput.value);
        });

        trackingInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                trackShipment(trackingInput.value);
            }
        });

        // Check URL for tracking number
        window.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const trackingNumber = urlParams.get('number') || urlParams.get('tracking');
            
            if (trackingNumber) {
                trackingInput.value = trackingNumber;
                trackShipment(trackingNumber);
            }
        });

        // Check if user is logged in and update nav
        async function checkAuthStatus() {
            try {
                const response = await fetch('/auth/profile/');
                if (response.ok) {
                    // User is logged in
                    document.getElementById('navAuth').style.display = 'none';
                    document.getElementById('navAuthLoggedIn').style.display = 'flex';
                }
            } catch (error) {
                // User is not logged in, keep default nav
            }
        }
        checkAuthStatus();

        // Mobile Menu Toggle
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const navMenu = document.getElementById('navMenu');
        const navAuth = document.getElementById('navAuth');
        const navAuthLoggedIn = document.getElementById('navAuthLoggedIn');

        if (mobileMenuBtn) {
            mobileMenuBtn.addEventListener('click', function() {
                this.classList.toggle('active');
                navMenu.classList.toggle('active');
                
                if (navAuth && navAuth.style.display !== 'none') {
                    navAuth.classList.toggle('active');
                }
                if (navAuthLoggedIn && navAuthLoggedIn.style.display !== 'none') {
                    navAuthLoggedIn.classList.toggle('active');
                }
            });
        }
    </script>
</body>
</html>
